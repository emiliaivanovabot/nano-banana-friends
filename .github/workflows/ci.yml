name: ğŸš€ CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  NODE_VERSION: '20'
  CACHE_VERSION: v1

jobs:
  # Quality Gates - Run in parallel for speed
  quality-checks:
    name: ğŸ” Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ§¹ Check Code Style
        run: |
          # Check for common code style issues
          echo "Checking for console.log statements (should be minimal in production)..."
          if grep -r "console.log" src/ --exclude-dir=node_modules --exclude="*.test.*" --exclude="*.spec.*"; then
            echo "âš ï¸ Found console.log statements. Consider using proper logging in production."
          fi
          
          echo "Checking for TODO comments..."
          if grep -r "TODO\|FIXME\|HACK" src/ --exclude-dir=node_modules; then
            echo "â„¹ï¸ Found TODO/FIXME comments. Review before production deployment."
          fi
          
      - name: ğŸ” Check Bundle Size
        run: |
          npm run build
          
          # Get bundle size and check against limits
          BUNDLE_SIZE=$(du -sk dist | cut -f1)
          BUNDLE_SIZE_MB=$((BUNDLE_SIZE / 1024))
          
          echo "Bundle size: ${BUNDLE_SIZE_MB}MB"
          
          # Alert if bundle is larger than 5MB (current optimized size is ~65KB)
          if [ $BUNDLE_SIZE_MB -gt 5 ]; then
            echo "âš ï¸ Bundle size exceeded 5MB limit. Current: ${BUNDLE_SIZE_MB}MB"
            exit 1
          fi
          
          echo "âœ… Bundle size check passed: ${BUNDLE_SIZE_MB}MB"

  # Build Verification
  build-test:
    name: ğŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    strategy:
      matrix:
        node-version: ['18', '20']
        
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ—ï¸ Build Application
        run: |
          echo "Building for production..."
          npm run build
          
      - name: âœ… Verify Build Output
        run: |
          # Check if build succeeded and created necessary files
          if [ ! -d "dist" ]; then
            echo "âŒ Build failed - dist directory not created"
            exit 1
          fi
          
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ Build failed - index.html not found"
            exit 1
          fi
          
          echo "âœ… Build verification passed"
          
          # List build output for debugging
          echo "Build output structure:"
          find dist -type f -name "*.js" -o -name "*.css" -o -name "*.html" | head -10
          
      - name: ğŸ§ª Test Preview Server
        run: |
          # Start preview server in background and test it
          npm run preview &
          PREVIEW_PID=$!
          
          # Wait for server to start
          sleep 5
          
          # Test if server responds
          if curl -f http://localhost:4173 > /dev/null 2>&1; then
            echo "âœ… Preview server test passed"
          else
            echo "âŒ Preview server test failed"
            kill $PREVIEW_PID 2>/dev/null || true
            exit 1
          fi
          
          # Cleanup
          kill $PREVIEW_PID 2>/dev/null || true
          
      - name: ğŸ“Š Upload Build Artifacts
        if: matrix.node-version == '20'
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # Security Scanning
  security-scan:
    name: ğŸ›¡ï¸ Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ” Audit Dependencies
        run: |
          echo "Checking for vulnerable dependencies..."
          npm audit --audit-level=moderate || {
            echo "âš ï¸ Found security vulnerabilities. Running npm audit fix..."
            npm audit fix --dry-run
            exit 1
          }
          
      - name: ğŸ”’ Check for Secrets
        run: |
          echo "Scanning for potential secrets..."
          
          # Check for common secret patterns
          if grep -r -i "password\|secret\|key\|token" src/ --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" | grep -v "placeholder\|example\|demo"; then
            echo "âš ï¸ Found potential secrets in code. Please review."
            echo "Note: This might be false positive for legitimate usage."
          fi
          
          echo "âœ… Secret scan completed"

  # Performance Testing
  performance-test:
    name: âš¡ Performance Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-test]
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ—ï¸ Build for Performance Test
        run: npm run build
        
      - name: ğŸ“ˆ Analyze Bundle
        run: |
          echo "Analyzing bundle composition..."
          
          # Check for large dependencies
          echo "Largest files in build:"
          find dist -name "*.js" -exec ls -lh {} \; | sort -k5 -hr | head -10
          
          # Count total files
          JS_FILES=$(find dist -name "*.js" | wc -l)
          CSS_FILES=$(find dist -name "*.css" | wc -l)
          
          echo "JavaScript files: $JS_FILES"
          echo "CSS files: $CSS_FILES"
          
          # Performance recommendations
          if [ $JS_FILES -gt 20 ]; then
            echo "âš ï¸ Consider code splitting - many JS files detected"
          fi
          
          echo "âœ… Bundle analysis completed"

  # Integration Test
  integration-test:
    name: ğŸ”— Integration Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [quality-checks, build-test]
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ—ï¸ Build Application
        run: npm run build
        
      - name: ğŸ§ª API Endpoint Test
        run: |
          echo "Testing API endpoints availability..."
          
          # Start the API server if available
          if [ -f "api/package.json" ]; then
            cd api
            npm ci --prefer-offline --no-audit
            npm start &
            API_PID=$!
            cd ..
            
            # Wait for API to start
            sleep 10
            
            # Test basic API health
            if curl -f http://localhost:3000/health > /dev/null 2>&1 || curl -f http://localhost:8000/health > /dev/null 2>&1; then
              echo "âœ… API health check passed"
            else
              echo "â„¹ï¸ API health check skipped - endpoint may not be available"
            fi
            
            # Cleanup
            kill $API_PID 2>/dev/null || true
          else
            echo "â„¹ï¸ No API server configuration found"
          fi

  # Deployment Ready Check
  deployment-ready:
    name: ğŸš€ Deployment Ready
    runs-on: ubuntu-latest
    needs: [quality-checks, build-test, security-scan, performance-test, integration-test]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: âœ… All Checks Passed
        run: |
          echo "ğŸ‰ All quality gates passed!"
          echo "âœ… Code quality checks completed"
          echo "âœ… Build verification successful"
          echo "âœ… Security scan completed"
          echo "âœ… Performance tests passed"
          echo "âœ… Integration tests completed"
          echo ""
          echo "Ready for deployment to staging/production"
          
      - name: ğŸ”” Notify Success
        run: |
          echo "CI/CD Pipeline completed successfully"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Author: ${{ github.actor }}"