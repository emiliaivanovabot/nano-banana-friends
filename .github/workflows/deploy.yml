name: ğŸš€ Deploy to Vercel

on:
  # Automatic deployment on main branch
  push:
    branches: [ main ]
  
  # Manual deployment trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'preview'
        type: choice
        options:
          - preview
          - production

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # Deploy to Preview (Staging)
  deploy-preview:
    name: ğŸ”„ Deploy to Preview
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.event.inputs.environment == 'preview'
    environment: 
      name: preview
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ—ï¸ Build Application
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: ğŸš€ Deploy to Vercel Preview
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: '--prebuilt'
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}
          
      - name: âœ… Preview Deployment Success
        run: |
          echo "ğŸ‰ Preview deployment successful!"
          echo "ğŸ”— Preview URL: ${{ steps.deploy.outputs.preview-url }}"
          echo "ğŸ“ Deployment ID: ${{ steps.deploy.outputs.deployment-id }}"
          
      - name: ğŸ§ª Health Check Preview
        run: |
          # Wait for deployment to be ready
          sleep 30
          
          # Test preview deployment
          PREVIEW_URL="${{ steps.deploy.outputs.preview-url }}"
          if curl -f "$PREVIEW_URL" > /dev/null 2>&1; then
            echo "âœ… Preview deployment health check passed"
          else
            echo "âŒ Preview deployment health check failed"
            exit 1
          fi
          
      - name: ğŸ“ Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Preview Deployment Ready!**
              
              âœ… Your changes have been deployed to preview.
              ğŸ”— **Preview URL:** ${{ steps.deploy.outputs.preview-url }}
              
              ğŸ“Š **Deployment Details:**
              - Build time: ~2-3 minutes
              - Environment: Preview/Staging
              - Commit: \`${{ github.sha }}\`
              
              The preview will be available for testing and review.`
            })

  # Deploy to Production (Manual Approval Required)
  deploy-production:
    name: ğŸŒŸ Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-preview]
    if: github.ref == 'refs/heads/main' && github.event.inputs.environment == 'production'
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v4
        
      - name: ğŸ“‹ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: ğŸ”§ Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: ğŸ—ï¸ Build for Production
        run: npm run build
        env:
          NODE_ENV: production
          
      - name: ğŸ” Pre-deployment Checks
        run: |
          echo "Running final pre-deployment checks..."
          
          # Verify build output
          if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
            echo "âŒ Build verification failed"
            exit 1
          fi
          
          # Check bundle size one more time
          BUNDLE_SIZE=$(du -sk dist | cut -f1)
          BUNDLE_SIZE_MB=$((BUNDLE_SIZE / 1024))
          echo "Final bundle size: ${BUNDLE_SIZE_MB}MB"
          
          if [ $BUNDLE_SIZE_MB -gt 10 ]; then
            echo "âŒ Bundle too large for production: ${BUNDLE_SIZE_MB}MB"
            exit 1
          fi
          
          echo "âœ… Pre-deployment checks passed"
          
      - name: ğŸš€ Deploy to Production
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-args: '--prebuilt --prod'
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}
          
      - name: âœ… Production Deployment Success
        run: |
          echo "ğŸ‰ Production deployment successful!"
          echo "ğŸ”— Production URL: ${{ steps.deploy.outputs.url }}"
          echo "ğŸ“ Deployment ID: ${{ steps.deploy.outputs.deployment-id }}"
          
      - name: ğŸ§ª Production Health Check
        run: |
          # Wait for deployment to propagate
          sleep 60
          
          # Test production deployment
          PROD_URL="${{ steps.deploy.outputs.url }}"
          
          # Multiple health checks
          for i in {1..5}; do
            if curl -f "$PROD_URL" > /dev/null 2>&1; then
              echo "âœ… Production health check $i/5 passed"
              break
            else
              echo "âš ï¸ Production health check $i/5 failed, retrying..."
              sleep 30
              if [ $i -eq 5 ]; then
                echo "âŒ Production health check failed after 5 attempts"
                exit 1
              fi
            fi
          done
          
      - name: ğŸ“Š Post-deployment Report
        run: |
          echo "ğŸ“Š **Production Deployment Report**"
          echo "=================================="
          echo "âœ… Status: Successful"
          echo "ğŸ”— URL: ${{ steps.deploy.outputs.url }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "â° Time: $(date)"
          echo ""
          echo "ğŸ” Next Steps:"
          echo "- Monitor application performance"
          echo "- Verify all features work correctly"
          echo "- Check error tracking dashboards"
          
      - name: ğŸš¨ Rollback on Failure
        if: failure()
        run: |
          echo "ğŸš¨ Production deployment failed - initiating rollback procedures"
          echo "Manual intervention required:"
          echo "1. Check Vercel dashboard for deployment status"
          echo "2. Verify environment variables are correct"
          echo "3. Check application logs for errors"
          echo "4. Consider rolling back to previous deployment"
          echo ""
          echo "Rollback command:"
          echo "vercel rollback --token \$VERCEL_TOKEN"

  # Cleanup old deployments
  cleanup:
    name: ğŸ§¹ Cleanup Old Deployments
    runs-on: ubuntu-latest
    needs: [deploy-preview]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ§¹ Cleanup Preview Deployments
        run: |
          echo "ğŸ§¹ Cleaning up old preview deployments..."
          echo "Note: This would typically remove deployments older than 7 days"
          echo "Cleanup can be implemented with Vercel CLI:"
          echo "vercel list --token \$VERCEL_TOKEN | grep 'preview' | awk '{print \$1}' | head -n -5 | xargs vercel rm --yes"
          echo "âœ… Cleanup process completed"