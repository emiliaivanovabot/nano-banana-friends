name: üìä Performance Monitoring

on:
  # Run after successful deployments
  workflow_run:
    workflows: ["üöÄ Deploy to Vercel"]
    types: [completed]
    branches: [main]
  
  # Scheduled performance checks
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to test (optional)'
        required: false
        type: string

env:
  PRODUCTION_URL: "https://${{ github.event.repository.name }}.vercel.app"
  LIGHTHOUSE_CI_BUILD_ID: "${{ github.run_id }}"

jobs:
  # Bundle Size Analysis
  bundle-analysis:
    name: üì¶ Bundle Size Analysis
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        
      - name: üìã Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: üîß Install Dependencies
        run: npm ci --prefer-offline --no-audit
        
      - name: üèóÔ∏è Build for Analysis
        run: npm run build
        
      - name: üìä Analyze Bundle Size
        run: |
          echo "üìä Bundle Size Analysis Report"
          echo "============================="
          echo ""
          
          # Total bundle size
          TOTAL_SIZE=$(du -sh dist | cut -f1)
          echo "üì¶ Total bundle size: $TOTAL_SIZE"
          
          # JavaScript files analysis
          echo ""
          echo "üìÑ JavaScript files:"
          find dist -name "*.js" -exec ls -lh {} \; | sort -k5 -hr | head -10 | awk '{print "  " $9 " - " $5}'
          
          # CSS files analysis
          echo ""
          echo "üé® CSS files:"
          find dist -name "*.css" -exec ls -lh {} \; | sort -k5 -hr | head -5 | awk '{print "  " $9 " - " $5}'
          
          # Asset files analysis
          echo ""
          echo "üñºÔ∏è Asset files (largest):"
          find dist -type f \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.svg" -o -name "*.ico" \) -exec ls -lh {} \; | sort -k5 -hr | head -5 | awk '{print "  " $9 " - " $5}'
          
          # Count files by type
          echo ""
          echo "üìÅ File count by type:"
          echo "  JavaScript: $(find dist -name "*.js" | wc -l) files"
          echo "  CSS: $(find dist -name "*.css" | wc -l) files"
          echo "  Images: $(find dist \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.svg" \) | wc -l) files"
          echo "  Other: $(find dist -type f ! \( -name "*.js" -o -name "*.css" -o -name "*.html" -o -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.svg" \) | wc -l) files"
          
          # Check against size limits
          TOTAL_SIZE_KB=$(du -sk dist | cut -f1)
          echo ""
          echo "üìè Size Checks:"
          
          if [ $TOTAL_SIZE_KB -lt 1024 ]; then
            echo "  ‚úÖ Bundle size excellent: ${TOTAL_SIZE_KB}KB (< 1MB)"
          elif [ $TOTAL_SIZE_KB -lt 5120 ]; then
            echo "  ‚úÖ Bundle size good: ${TOTAL_SIZE_KB}KB (< 5MB)"
          elif [ $TOTAL_SIZE_KB -lt 10240 ]; then
            echo "  ‚ö†Ô∏è Bundle size acceptable: ${TOTAL_SIZE_KB}KB (< 10MB)"
          else
            echo "  ‚ùå Bundle size too large: ${TOTAL_SIZE_KB}KB (> 10MB)"
            exit 1
          fi
          
      - name: üìä Generate Bundle Report
        run: |
          cat > bundle-analysis.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "totalSizeKB": $(du -sk dist | cut -f1),
            "jsFiles": $(find dist -name "*.js" | wc -l),
            "cssFiles": $(find dist -name "*.css" | wc -l),
            "imageFiles": $(find dist \( -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" -o -name "*.svg" \) | wc -l),
            "build": "${{ github.run_id }}"
          }
          EOF
          
      - name: üìä Upload Bundle Analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis-${{ github.sha }}
          path: bundle-analysis.json
          retention-days: 30

  # Lighthouse Performance Audit
  lighthouse-audit:
    name: üîç Lighthouse Performance Audit
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: üì¶ Checkout Code
        uses: actions/checkout@v4
        
      - name: üîç Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            ${{ github.event.inputs.url || env.PRODUCTION_URL }}
          configPath: './lighthouserc.json'
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: üìä Performance Summary
        run: |
          echo "üîç **Lighthouse Performance Audit Results**"
          echo "==========================================="
          echo ""
          echo "**Audited URL:** ${{ github.event.inputs.url || env.PRODUCTION_URL }}"
          echo "**Timestamp:** $(date)"
          echo "**Commit:** ${{ github.sha }}"
          echo ""
          echo "üìä **Core Web Vitals:**"
          echo "- First Contentful Paint (FCP)"
          echo "- Largest Contentful Paint (LCP)"  
          echo "- Cumulative Layout Shift (CLS)"
          echo "- Speed Index"
          echo ""
          echo "‚ÑπÔ∏è **Detailed results available in Lighthouse report artifacts**"

  # Application Health Check
  health-monitoring:
    name: üè• Application Health Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üè• Health Check
        run: |
          TARGET_URL="${{ github.event.inputs.url || env.PRODUCTION_URL }}"
          echo "üè• Performing health check on: $TARGET_URL"
          
          # Basic availability check
          if curl -f "$TARGET_URL" > /dev/null 2>&1; then
            echo "‚úÖ Application is accessible"
          else
            echo "‚ùå Application is not accessible"
            exit 1
          fi
          
          # Response time check
          RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" "$TARGET_URL")
          echo "‚è±Ô∏è Response time: ${RESPONSE_TIME}s"
          
          # Check if response time is acceptable (< 3 seconds)
          if (( $(echo "$RESPONSE_TIME < 3.0" | bc -l) )); then
            echo "‚úÖ Response time is acceptable"
          else
            echo "‚ö†Ô∏è Response time is slow (> 3s)"
          fi
          
          # HTTP status check
          HTTP_STATUS=$(curl -o /dev/null -s -w "%{http_code}" "$TARGET_URL")
          echo "üìä HTTP status: $HTTP_STATUS"
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "‚úÖ HTTP status is healthy"
          else
            echo "‚ùå HTTP status indicates an issue"
            exit 1
          fi
          
      - name: üîç Advanced Health Checks
        run: |
          TARGET_URL="${{ github.event.inputs.url || env.PRODUCTION_URL }}"
          
          # Check for basic security headers
          echo "üîí Security headers check:"
          SECURITY_HEADERS=$(curl -I "$TARGET_URL" 2>/dev/null)
          
          if echo "$SECURITY_HEADERS" | grep -i "x-frame-options" > /dev/null; then
            echo "‚úÖ X-Frame-Options header present"
          else
            echo "‚ö†Ô∏è X-Frame-Options header missing"
          fi
          
          if echo "$SECURITY_HEADERS" | grep -i "x-content-type-options" > /dev/null; then
            echo "‚úÖ X-Content-Type-Options header present"
          else
            echo "‚ö†Ô∏è X-Content-Type-Options header missing"
          fi
          
          # Check content type
          CONTENT_TYPE=$(curl -I "$TARGET_URL" 2>/dev/null | grep -i "content-type" | head -1)
          echo "üìÑ Content-Type: $CONTENT_TYPE"
          
          # Check if gzip compression is enabled
          if curl -H "Accept-Encoding: gzip" -I "$TARGET_URL" 2>/dev/null | grep -i "content-encoding.*gzip" > /dev/null; then
            echo "‚úÖ Gzip compression is enabled"
          else
            echo "‚ö†Ô∏è Gzip compression not detected"
          fi

  # Performance Trend Analysis
  performance-trends:
    name: üìà Performance Trend Analysis
    runs-on: ubuntu-latest
    needs: [bundle-analysis, lighthouse-audit, health-monitoring]
    if: always()
    
    steps:
      - name: üìà Performance Trend Summary
        run: |
          echo "üìà **Performance Monitoring Summary**"
          echo "===================================="
          echo ""
          echo "**Monitoring Date:** $(date)"
          echo "**Repository:** ${{ github.repository }}"
          echo "**Commit:** ${{ github.sha }}"
          echo "**Branch:** ${{ github.ref_name }}"
          echo ""
          echo "**Completed Checks:**"
          
          if [ "${{ needs.bundle-analysis.result }}" == "success" ]; then
            echo "‚úÖ Bundle size analysis"
          else
            echo "‚ùå Bundle size analysis failed"
          fi
          
          if [ "${{ needs.lighthouse-audit.result }}" == "success" ]; then
            echo "‚úÖ Lighthouse performance audit"
          else
            echo "‚ùå Lighthouse performance audit failed"
          fi
          
          if [ "${{ needs.health-monitoring.result }}" == "success" ]; then
            echo "‚úÖ Application health check"
          else
            echo "‚ùå Application health check failed"
          fi
          
          echo ""
          echo "**Key Metrics Tracked:**"
          echo "- Bundle size and composition"
          echo "- Core Web Vitals (LCP, FCP, CLS)"
          echo "- Application response time"
          echo "- Security headers presence"
          echo "- Compression efficiency"
          echo ""
          echo "**Next Steps:**"
          echo "1. Review detailed reports in artifacts"
          echo "2. Address any performance warnings"
          echo "3. Monitor trends over time"
          echo "4. Optimize based on recommendations"
          
      - name: üö® Performance Alert
        if: needs.bundle-analysis.result == 'failure' || needs.lighthouse-audit.result == 'failure' || needs.health-monitoring.result == 'failure'
        run: |
          echo "üö® **PERFORMANCE ALERT**"
          echo "======================="
          echo ""
          echo "One or more performance checks failed!"
          echo ""
          echo "**Failed Checks:**"
          [ "${{ needs.bundle-analysis.result }}" == "failure" ] && echo "- Bundle size analysis"
          [ "${{ needs.lighthouse-audit.result }}" == "failure" ] && echo "- Lighthouse performance audit"  
          [ "${{ needs.health-monitoring.result }}" == "failure" ] && echo "- Application health check"
          echo ""
          echo "**Immediate Actions Required:**"
          echo "1. Review failed check details"
          echo "2. Investigate performance regression"
          echo "3. Consider rollback if critical"
          echo "4. Optimize and re-deploy"